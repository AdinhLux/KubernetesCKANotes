A new member akshay joined our team. He requires access to our cluster. 
The Certificate Signing Request is at the /root location.

controlplane ~ âžœ  ls /root
akshay.csr  akshay.key





Q:
--
Create a CertificateSigningRequest object with the name akshay with the contents of the akshay.csr file

As of kubernetes 1.19, the API to use for CSR is certificates.k8s.io/v1.

Please note that an additional field called signerName should also be added when creating CSR. 
For client authentication to the API server we will use the built-in signer kubernetes.io/kube-apiserver-client.


A:
--
1) Use this command to generate the base64 encoded format as following:

$ cat akshay.csr | base64 -w 0

LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZqQ0NBVDRDQVFBd0VURVBNQTBHQTFVRUF3d0dZV3R6YUdGNU1JSUJJakFOQmdrcWhraUc5dzBCQVFFRgpBQU9DQVE4QU1JSUJDZ0tDQVFFQXV0UmMrRU1nTXpQMGJoTUZNSCtwVDFQNFc3THNHN1lQckFONDNqaUJZUnpuCjRKeStmMVdnRS9QYmord1o1cjVtTkFldFVxYmJPMG5hQzBvQXR3MGg4M1hxbFhmb3lNWDZoZCt6Q3g3Ni9YOHQKbXFhc0ZPclJBM25ZZ2pUblFSVGZVQjg5NUxlNVhPZWhsa2JPSXMyWlgza1Z1VjhNT0tFbmxhWmVXOXA0M3ExOQppdW1DNE9vSjNPdGlwdG0zVldwSUp2QVpid2tseHlDc3NscnphRVB3QzFLTGhtdlNiLzlIU2NUckZCdDlBRG4wCkU4R0M5WnZpY1JHYzlHNFZUQ0U5S2ZvR1ZONmJQdC9LSFkxNmpISmZ1M1dEVHdOZXNFdURPOTVTcDlOK1hiVUcKSkNPdEtPcm1wMVdPQWdMeVhsZnRIdWlxYjVaZUd4Tno5K1VHVWdOVE13SURBUUFCb0FBd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnRUJBSmhGTU13c1lsQTdVYTcyM3BIWWRDdHJwT1NxSmw1cUcrRGNUWVBIc3ZPaFc1M05iWThiCjZScFVTNTRwejVDNyszZHE0UjhzTk1MSGFKalpsQk1UekM5UHR2Uk4rSU1TdGVwMGJVbVFJRjNIVXJUQTJnNUgKR3NiUi8relFJcUdwZTFjbStiOGNKQWNMTHNHK25CUFdObGRYdG0vcDk2ZUY2dkt2QVBrLzVMZlE5VDdVeUVXcwpjUEV1WmtwVkxUNUs3RitxUzZBVXordmtQUDVMZnRvaHV4M1p1TDBJemwyQ2p3bFJ6MmZubWZtWnQ3emt6dXFJCmdVY1Zib1pTM0VjMEdhOVg3c25ZNmVueWt5YzE3MnZRTmlEY3loeWQyWm5MWSt6T3lBVmlQakpEY0lYUFdZUGsKQjMxKzVOMWw3RWVudm90Y3c3Ui8vV2ZyTGF4NzFJMjRoTW89Ci0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=

2) Finally, save the below YAML in a file and create a CSR name akshay as follows:

$ vi akshay-csr.yaml

```
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: akshay
spec:
  groups:
  - system:authenticated  request:     LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZqQ0NBVDRDQVFBd0VURVBNQTBHQTFVRUF3d0dZV3R6YUdGNU1JSUJJakFOQmdrcWhraUc5dzBCQVFFRgpBQU9DQVE4QU1JSUJDZ0tDQVFFQXV0UmMrRU1nTXpQMGJoTUZNSCtwVDFQNFc3THNHN1lQckFONDNqaUJZUnpuCjRKeStmMVdnRS9QYmord1o1cjVtTkFldFVxYmJPMG5hQzBvQXR3MGg4M1hxbFhmb3lNWDZoZCt6Q3g3Ni9YOHQKbXFhc0ZPclJBM25ZZ2pUblFSVGZVQjg5NUxlNVhPZWhsa2JPSXMyWlgza1Z1VjhNT0tFbmxhWmVXOXA0M3ExOQppdW1DNE9vSjNPdGlwdG0zVldwSUp2QVpid2tseHlDc3NscnphRVB3QzFLTGhtdlNiLzlIU2NUckZCdDlBRG4wCkU4R0M5WnZpY1JHYzlHNFZUQ0U5S2ZvR1ZONmJQdC9LSFkxNmpISmZ1M1dEVHdOZXNFdURPOTVTcDlOK1hiVUcKSkNPdEtPcm1wMVdPQWdMeVhsZnRIdWlxYjVaZUd4Tno5K1VHVWdOVE13SURBUUFCb0FBd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnRUJBSmhGTU13c1lsQTdVYTcyM3BIWWRDdHJwT1NxSmw1cUcrRGNUWVBIc3ZPaFc1M05iWThiCjZScFVTNTRwejVDNyszZHE0UjhzTk1MSGFKalpsQk1UekM5UHR2Uk4rSU1TdGVwMGJVbVFJRjNIVXJUQTJnNUgKR3NiUi8relFJcUdwZTFjbStiOGNKQWNMTHNHK25CUFdObGRYdG0vcDk2ZUY2dkt2QVBrLzVMZlE5VDdVeUVXcwpjUEV1WmtwVkxUNUs3RitxUzZBVXordmtQUDVMZnRvaHV4M1p1TDBJemwyQ2p3bFJ6MmZubWZtWnQ3emt6dXFJCmdVY1Zib1pTM0VjMEdhOVg3c25ZNmVueWt5YzE3MnZRTmlEY3loeWQyWm5MWSt6T3lBVmlQakpEY0lYUFdZUGsKQjMxKzVOMWw3RWVudm90Y3c3Ui8vV2ZyTGF4NzFJMjRoTW89Ci0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - client auth
```

$ kubectl apply -f akshay-csr.yaml
certificatesigningrequest.certificates.k8s.io/akshay created

===============================================================================================================================

Q:
--
What is the Condition of the newly created Certificate Signing Request object ?


A:
--
$ kubectl get csr

NAME        AGE   SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
akshay      29s   kubernetes.io/kube-apiserver-client           kubernetes-admin           <none>              Pending
csr-rp88z   11m   kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued


===============================================================================================================================

Q:
--
Approve the CSR Request


A:
--
$ kubectl certificate approve akshay
certificatesigningrequest.certificates.k8s.io/akshay approved


===============================================================================================================================

Q:
--
How many CSR requests are available on the cluster ?


A:
--
$ kubectl get csr

NAME        AGE    SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
akshay      2m5s   kubernetes.io/kube-apiserver-client           kubernetes-admin           <none>              Approved,Issued
csr-rp88z   13m    kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued


===============================================================================================================================

Q:
--
During a routine check you realized that there is a new CSR request in place. What is the name of this request ?


A:
--
$ kubectl get csr

NAME          AGE     SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
agent-smith   19s     kubernetes.io/kube-apiserver-client           agent-x                    <none>              Pending
akshay        3m15s   kubernetes.io/kube-apiserver-client           kubernetes-admin           <none>              Approved,Issued
csr-rp88z     14m     kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued


===============================================================================================================================

Q:
--
Hmmm.. You are not aware of a request coming in. What groups is this CSR requesting access to ?

Check the details about the request. Preferebly in YAML.


A:
--
$ kubectl get csr agent-smith -o yaml

```
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  creationTimestamp: "2023-03-14T11:25:58Z"
  name: agent-smith
  resourceVersion: "1541"
  uid: e77f42d6-afc6-4f7c-9860-5031857ebb24
spec:
  groups:
  - system:masters
  - system:authenticated
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1dEQ0NBVUFDQVFBd0V6RVJNQThHQTFVRUF3d0libVYzTFhWelpYSXdnZ0VpTUEwR0NTcUdTSWIzRFFFQgpBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRRE8wV0pXK0RYc0FKU0lyanBObzV2UklCcGxuemcrNnhjOStVVndrS2kwCkxmQzI3dCsxZUVuT041TXVxOTlOZXZtTUVPbnJEVU8vdGh5VnFQMncyWE5JRFJYall5RjQwRmJtRCs1eld5Q0sKeTNCaWhoQjkzTUo3T3FsM1VUdlo4VEVMcXlhRGtuUmwvanYvU3hnWGtvazBBQlVUcFdNeDRCcFNpS2IwVSt0RQpJRjVueEF0dE1Wa0RQUTdOYmVaUkc0M2IrUVdsVkdSL3o2RFdPZkpuYmZlek90YUF5ZEdMVFpGQy93VHB6NTJrCkVjQ1hBd3FDaGpCTGt6MkJIUFI0Sjg5RDZYYjhrMzlwdTZqcHluZ1Y2dVAwdEliT3pwcU52MFkwcWRFWnB3bXcKajJxRUwraFpFV2trRno4MGxOTnR5VDVMeE1xRU5EQ25JZ3dDNEdaaVJHYnJBZ01CQUFHZ0FEQU5CZ2txaGtpRwo5dzBCQVFzRkFBT0NBUUVBUzlpUzZDMXV4VHVmNUJCWVNVN1FGUUhVemFsTnhBZFlzYU9SUlFOd0had0hxR2k0CmhPSzRhMnp5TnlpNDRPT2lqeWFENnRVVzhEU3hrcjhCTEs4S2czc3JSRXRKcWw1ckxaeTlMUlZyc0pnaEQ0Z1kKUDlOTCthRFJTeFJPVlNxQmFCMm5XZVlwTTVjSjVURjUzbGVzTlNOTUxRMisrUk1uakRRSjdqdVBFaWM4L2RoawpXcjJFVU02VWF3enlrcmRISW13VHYybWxNWTBSK0ROdFYxWWllKzBIOS9ZRWx0K0ZTR2poNUw1WVV2STFEcWl5CjRsM0UveTNxTDcxV2ZBY3VIM09zVnBVVW5RSVNNZFFzMHFXQ3NiRTU2Q0M1RGhQR1pJcFVibktVcEF3a2ErOEUKdndRMDdqRytocGtueG11RkFlWHhnVXdvZEFMYUo3anUvVERJY3c9PQotLS0tLUVORCBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0K
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - digital signature
  - key encipherment
  - server auth
  username: agent-x
status: {}
```


===============================================================================================================================

Q:
--
That doesn't look very right. Reject that request.


A:
--
$ kubectl certificate deny agent-smit
certificatesigningrequest.certificates.k8s.io/agent-smith denied

$ kubectl get csr

NAME          AGE     SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
agent-smith   7m43s   kubernetes.io/kube-apiserver-client           agent-x                    <none>              Denied
akshay        10m     kubernetes.io/kube-apiserver-client           kubernetes-admin           <none>              Approved,Issued
csr-rp88z     22m     kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued


===============================================================================================================================

Q:
--
Let's get rid of it. Delete the new CSR object


A:
--
$ kubectl delete csr agent-smith

certificatesigningrequest.certificates.k8s.io "agent-smith" deleted
